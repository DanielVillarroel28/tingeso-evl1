version: "3.8"
services:
  # --- Backend Spring Boot ---
  backend1:
    extra_hosts:
      # Permite que el contenedor vea servicios locales (DB y Keycloak)
      - "host.docker.internal:host-gateway"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://host.docker.internal:5432/postgres
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: 1234
      # El issuer debe coincidir EXACTAMENTE con el 'iss' del token (desde el navegador es http://localhost:9090)
      SPRING_SECURITY_OAUTH2_CLIENT_PROVIDER_KEYCLOAK_ISSUER_URI: http://localhost:9090/realms/toolrent-realm
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI: http://localhost:9090/realms/toolrent-realm
      # El contenedor necesita resolver las claves (JWKS) desde el host
      SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_JWK_SET_URI: http://host.docker.internal:9090/realms/toolrent-realm/protocol/openid-connect/certs
      # Usar propiedades espec√≠ficas para Docker si es necesario
      SPRING_PROFILES_ACTIVE: docker
    ports:
      - "8090:8090"
    networks:
      - toolrent-network

  # --- Frontend React + Nginx ---
  # =========================
  # FRONTENDS
  # =========================
  frontend1:
    image: danielv28/tingeso_frontend:latest
    depends_on:
      - nginx-backend
    networks: toolrent-network

nginx-frontend:
    image: nginx:latest
    ports:
      - "5173:80"
    volumes:
      - ./nginx-frontend.conf:/etc/nginx/nginx.conf
    depends_on:
      - frontend1
    networks: toolrent-network

nginx-backend:
    image: nginx:latest
    ports:
      - "8090:8090"
    volumes:
      - ./nginx-backend.conf:/etc/nginx/nginx.conf
    depends_on:
      - backend1
    networks: toolrent-network


networks:
  toolrent-network:
    driver: bridge
